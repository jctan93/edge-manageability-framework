# SPDX-FileCopyrightText: 2025 Intel Corporation
#
# SPDX-License-Identifier: Apache-2.0

apiVersion: batch/v1
kind: Job
metadata:
  name: patch-rke2-bootstrap
  namespace: capr-system
spec:
  ttlSecondsAfterFinished: 300 # Automatically delete the Job 5 minutes after completion
  template:
    spec:
      serviceAccountName: argo-service-account
      containers:
        - name: patch-rke2-bootstrap
          image: bitnami/kubectl:latest
          command:
            - /bin/sh
            - -c
            - |
              kubectl patch deployment rke2-bootstrap-controller-manager -n capr-system --type=json --patch '[{"op": "replace", "path": "/spec/template/spec/containers/0/ports/2", "value": {"containerPort": 8080, "name": "metrics", "protocol": "TCP"}}, {"op": "replace", "path": "/spec/template/spec/containers/0/args/1", "value": "--diagnostics-address=:8080"}, {"op": "replace", "path": "/spec/template/spec/containers/0/args/2", "value": "--insecure-diagnostics=true"}]'
      restartPolicy: OnFailure
